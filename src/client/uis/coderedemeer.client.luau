local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")

local player = Players.LocalPlayer

-- Sons de feedback
local clickSound = game.StarterGui:WaitForChild("clicksound")
local hoverSound = game.StarterGui:WaitForChild("hoversound")

-- Fun√ß√µes de som
local function playClickSound()
    clickSound:Play()
end

local function playHoverSound()
    hoverSound:Play()
end

-- Importar lista de c√≥digos v√°lidos
local redeemableCodes = require(ReplicatedStorage.Shared["redeemable-codes"])

-- Aguardar ou criar o RemoteEvent para c√≥digos
local codeRedeemEvent = ReplicatedStorage:FindFirstChild("CodeRedeemEvent")
if not codeRedeemEvent then
    -- Se n√£o existir, aguardar que o servidor crie
    codeRedeemEvent = ReplicatedStorage:WaitForChild("CodeRedeemEvent")
end

-- Conectar para receber feedback do servidor sobre c√≥digos
codeRedeemEvent.OnClientEvent:Connect(function(success, message, code)
    if success then
        print("‚úÖ C√≥digo resgatado com sucesso:", code)
        print("üéÅ " .. message)
    else
        if message:find("j√° resgatou") then
            warn("‚ö†Ô∏è C√≥digo j√° resgatado:", code)
            print("üîÑ Debug: Este c√≥digo j√° foi usado anteriormente")
        else
            warn("‚ùå Erro ao resgatar c√≥digo:", code)
            print("üí¨ " .. message)
        end
    end
end)

-- Fun√ß√£o para configurar o bot√£o de c√≥digos
local function setupCodeRedeemer()
    local playerGui = player:WaitForChild("PlayerGui")
    
    -- Verificar se as interfaces necess√°rias existem
    local miscGui = playerGui:WaitForChild("MISC", 10)
    if not miscGui then
        warn("Interface MISC n√£o encontrada!")
        return
    end
    
    local codeButton = miscGui.BlackHolder:FindFirstChild("CodeButton")
    if not codeButton then
        warn("CodeButton n√£o encontrado em MISC.BlackHolder!")
        return
    end
    
    local codesGui = playerGui:WaitForChild("CODES", 10)
    if not codesGui then
        warn("Interface CODES n√£o encontrada!")
        return
    end
    
    local codesMenu = codesGui:FindFirstChild("BlackHolder")
    if not codesMenu then
        warn("BlackHolder n√£o encontrado em CODES!")
        return
    end
    
    -- Buscar CodeBox recursivamente na interface
    local function findCodeBox(parent)
        -- Primeiro, procurar diretamente no parent
        local directBox = parent:FindFirstChild("CodeBox")
        if directBox and directBox:IsA("TextBox") then
            return directBox
        end
        
        -- Se n√£o encontrou, procurar em todos os filhos
        for _, child in ipairs(parent:GetChildren()) do
            if child:IsA("GuiObject") then
                local foundBox = findCodeBox(child)
                if foundBox then
                    return foundBox
                end
            end
        end
        
        return nil
    end
    
    local codeBox = findCodeBox(codesMenu)
    if not codeBox then
        warn("CodeBox n√£o encontrado em CODES.BlackHolder! Elementos dispon√≠veis:")
        local function printChildren(parent, indent)
            for _, child in ipairs(parent:GetChildren()) do
                print(indent .. "- " .. child.Name .. " (" .. child.ClassName .. ")")
                if child:IsA("GuiObject") and #child:GetChildren() > 0 then
                    printChildren(child, indent .. "  ")
                end
            end
        end
        printChildren(codesMenu, "  ")
        return
    end
    
    -- Buscar bot√£o de resgate recursivamente
    local function findRedeemButton(parent)
        -- Procurar por nomes poss√≠veis de bot√£o
        local possibleNames = {"PurchaseButton", "RedeemButton", "SubmitButton", "Button"}
        
        for _, name in ipairs(possibleNames) do
            local button = parent:FindFirstChild(name)
            if button and (button:IsA("TextButton") or button:IsA("ImageButton")) then
                return button
            end
        end
        
        -- Se n√£o encontrou, procurar em todos os filhos
        for _, child in ipairs(parent:GetChildren()) do
            if child:IsA("GuiObject") then
                local foundButton = findRedeemButton(child)
                if foundButton then
                    return foundButton
                end
            end
        end
        
        return nil
    end
    
    local redeemButton = findRedeemButton(codesMenu)
    if not redeemButton then
        warn("Bot√£o de resgate n√£o encontrado em CODES.BlackHolder!")
        return
    end
    
    -- Buscar bot√£o Close (pode estar dentro de Background)
    local closeButton = codesMenu:FindFirstChild("Close")
    
    -- Se n√£o encontrou diretamente, procurar dentro de Background
    if not closeButton then
        local background = codesMenu:FindFirstChild("Background")
        if background then
            closeButton = background:FindFirstChild("Close")
        end
    end
    
    if closeButton and (closeButton:IsA("TextButton") or closeButton:IsA("ImageButton")) then
        print("‚úÖ Bot√£o Close encontrado:", closeButton:GetFullName())
    else
        warn("Bot√£o Close n√£o encontrado ou n√£o √© um bot√£o!")
    end
    
    print("‚úÖ Interface de c√≥digos configurada com sucesso!")
    print("  - CodeBox encontrado:", codeBox:GetFullName())
    print("  - Bot√£o de resgate encontrado:", redeemButton:GetFullName())
    
    -- Configurar clique no bot√£o de c√≥digos (abrir/fechar menu)
    codeButton.MouseButton1Click:Connect(function()
        playClickSound()
        codesMenu.Visible = not codesMenu.Visible
    end)
    
    -- Configurar clique no bot√£o Close (fechar menu)
    if closeButton then
        closeButton.MouseButton1Click:Connect(function()
            playClickSound()
            codesMenu.Visible = false
        end)
    end
    
    -- Configurar clique no bot√£o de resgate
    redeemButton.MouseButton1Click:Connect(function()
        playClickSound()
        local codeText = codeBox.Text
        
        -- Validar se o input n√£o est√° vazio
        if not codeText or codeText == "" or type(codeText) ~= "string" then
            -- Mostrar erro visual ou som (opcional)
            warn("C√≥digo inv√°lido: campo vazio ou inv√°lido")
            return
        end
        
        -- Limpar espa√ßos em branco
        codeText = string.gsub(codeText, "^%s*(.-)%s*$", "%1")
        
        -- Verificar se o c√≥digo existe na lista de c√≥digos v√°lidos
        if redeemableCodes[codeText] then
            -- C√≥digo v√°lido, enviar para o servidor
            print("üì§ Enviando c√≥digo v√°lido para o servidor:", codeText)
            codeRedeemEvent:FireServer(codeText)
            
            -- Limpar o campo de texto ap√≥s envio
            codeBox.Text = ""
        else
            -- C√≥digo inv√°lido - enviar mensagem no chat usando TextChatService
            local textChannel = TextChatService.TextChannels.RBXGeneral
            textChannel:DisplaySystemMessage("‚ùå C√≥digo inv√°lido!")
            
            -- Debug no console
            warn("‚ùå C√≥digo n√£o encontrado ou inv√°lido:", codeText)
            print("üîç Debug: C√≥digos v√°lidos dispon√≠veis:")
            for validCode, _ in pairs(redeemableCodes) do
                print("  - " .. validCode)
            end
        end
    end)
    
    -- Hover nos bot√µes
    codeButton.MouseEnter:Connect(playHoverSound)
    redeemButton.MouseEnter:Connect(playHoverSound)
    if closeButton then
        closeButton.MouseEnter:Connect(playHoverSound)
    end
end

-- Inicializa√ß√£o
player.CharacterAdded:Connect(setupCodeRedeemer)
if player.Character then
    setupCodeRedeemer()
end
