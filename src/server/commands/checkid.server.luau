local RegisterCommand = require(game.ReplicatedStorage.Shared["register-command"])
local Players = game:GetService("Players")
local ChatMessage = require(game.ServerScriptService.Server.framework.modules["chat-message"])
local UserIdModule = require(game.ServerScriptService.Server.framework.modules["user-id"])

RegisterCommand({
    name = "checkid",
    description = "Verifica disponibilidade de User ID ou consulta ID por username",
    aliases = { "verificarid", "idstatus" },
    permissions = { "owner", "admin" } -- Owners e admins podem verificar IDs
}, function(player, params, message)
    local input = params[1]

    -- Validar par√¢metros
    if not input then
        ChatMessage.sendError(player, "‚ùå Uso correto: /checkid <id_ou_username>\nüìã Exemplos:\n‚Ä¢ /checkid 666 (verifica se ID est√° dispon√≠vel)\n‚Ä¢ /checkid Nanazsj (mostra o ID do usu√°rio)")
        return
    end

    -- Verificar se √© um n√∫mero (ID) ou texto (username)
    local userId = tonumber(input)
    
    if userId then
        -- Input √© um n√∫mero - verificar disponibilidade do ID
        if userId <= 0 then
            ChatMessage.sendError(player, "‚ùå O User ID deve ser um n√∫mero positivo!")
            return
        end

        -- Verificar se o ID est√° em uso
        local isInUse = UserIdModule.isUserIdInUse(userId)
        
        if not isInUse then
            -- ID est√° dispon√≠vel
            local availableMessage = "‚úÖ User ID " .. userId .. " est√° DISPON√çVEL!\n"
            availableMessage = availableMessage .. "üÜî Status: Livre para uso"
            
            ChatMessage.sendSuccess(player, availableMessage)
        else
            -- ID est√° em uso, buscar informa√ß√µes do usu√°rio
            local playerName = UserIdModule.getPlayerNameByUserId(userId)
            local robloxId = UserIdModule.findRobloxIdByUserId(userId)
            
            local usedMessage = "‚ùå User ID " .. userId .. " est√° EM USO!\n"
            usedMessage = usedMessage .. "üÜî Status: Ocupado\n"
            
            if playerName then
                usedMessage = usedMessage .. "üë§ Usu√°rio: " .. playerName
            else
                usedMessage = usedMessage .. "üë§ Usu√°rio: [Nome n√£o encontrado]"
            end
            
            if robloxId then
                usedMessage = usedMessage .. "\nüîó Roblox ID: " .. robloxId
                
                -- Verificar se o jogador est√° online
                local onlinePlayer = Players:GetPlayerByUserId(robloxId)
                if onlinePlayer then
                    usedMessage = usedMessage .. "\nüü¢ Status: Online"
                else
                    usedMessage = usedMessage .. "\nüî¥ Status: Offline"
                end
            end
            
            ChatMessage.sendError(player, usedMessage)
        end
        
        -- Log da opera√ß√£o
        -- print("üîç [CHECKID] " .. player.Name .. " verificou o User ID " .. userId .. " - Status: " .. (isInUse and "EM USO" or "DISPON√çVEL"))
    else
        -- Input √© um username - buscar o User ID dessa pessoa
        local username = input
        
        -- Buscar o Roblox ID pelo username
        local success, robloxId = pcall(function()
            return Players:GetUserIdFromNameAsync(username)
        end)

        if not success then
            ChatMessage.sendError(player, "‚ùå Usu√°rio '" .. username .. "' n√£o encontrado!")
            return
        end

        -- Buscar o User ID do jogador
        local userIdFound = UserIdModule.getUserIdByRobloxId(robloxId)
        
        if not userIdFound then
            local noIdMessage = "‚ùå O usu√°rio '" .. username .. "' n√£o possui um User ID atribu√≠do!\n"
            noIdMessage = noIdMessage .. "üîó Roblox ID: " .. robloxId .. "\n"
            noIdMessage = noIdMessage .. "üí° O User ID ser√° criado quando o jogador entrar no servidor"
            
            ChatMessage.sendError(player, noIdMessage)
        else
            -- Mostrar informa√ß√µes do usu√°rio
            local userInfoMessage = "‚úÖ Informa√ß√µes do usu√°rio '" .. username .. "':\n"
            userInfoMessage = userInfoMessage .. "üÜî User ID: " .. userIdFound .. "\n"
            userInfoMessage = userInfoMessage .. "üîó Roblox ID: " .. robloxId
            
            -- Verificar se est√° online
            local onlinePlayer = Players:GetPlayerByUserId(robloxId)
            if onlinePlayer then
                userInfoMessage = userInfoMessage .. "\nüü¢ Status: Online"
            else
                userInfoMessage = userInfoMessage .. "\nüî¥ Status: Offline"
            end
            
            ChatMessage.sendSuccess(player, userInfoMessage)
        end
        
        -- Log da opera√ß√£o
        -- print("üîç [CHECKID] " .. player.Name .. " consultou o User ID de " .. username .. " - ID: " .. (userIdFound or "N√£o encontrado"))
    end
end) 