local RegisterCommand = require(game.ReplicatedStorage.Shared["register-command"])
local ChatMessage = require(game.ServerScriptService.Server.framework.modules["chat-message"])
local PlayerItemsModule = require(game.ServerScriptService.Server.framework.modules["player-items"])
local PlayerModule = require(game.ServerScriptService.Server.framework.modules.player)()
local ITEMS_MODULE = require(game.ReplicatedStorage.Shared.itens)
local ITEMS_CONFIG = ITEMS_MODULE.list
local ITEMS_BY_INDEX = ITEMS_MODULE.byIndex

RegisterCommand({
    name = "giveitem",
    description = "D√° um item para um jogador pelo User ID",
    aliases = { "gi", "item" },
    permissions = { "owner", "admin", "moderator" }
}, function(player, params, message)
    local userId = tonumber(params[1])
    local itemIdentifier = params[2] -- Pode ser ID ou nome
    local quantity = tonumber(params[3]) or 1
    
    -- Valida√ß√µes b√°sicas
    if not userId or not itemIdentifier then
        ChatMessage.sendError(player, "‚ùå Uso: /giveitem <userId> <itemId ou nome> [quantidade]")
        return
    end
    
    -- Tentar converter para ID (se for n√∫mero) ou buscar por nome
    local itemId = tonumber(itemIdentifier)
    if not itemId then
        -- N√£o √© n√∫mero, buscar por nome
        local trimmed = string.gsub(itemIdentifier, "^%s*(.-)%s*$", "%1")
        local normalizedName = string.lower(trimmed)
        itemId = ITEMS_BY_INDEX[normalizedName]
        
        if not itemId then
            ChatMessage.sendError(player, "‚ùå Item '" .. itemIdentifier .. "' n√£o encontrado!")
            return
        end
    end
    
    -- Verificar se o item existe
    if not ITEMS_CONFIG[itemId] then
        ChatMessage.sendError(player, "‚ùå Item ID '" .. itemId .. "' n√£o existe!")
        return
    end
    
    -- Buscar jogador pelo User ID customizado
    local targetPlayer = PlayerModule.getPlayerByUserId(userId)
    if not targetPlayer then
        ChatMessage.sendError(player, "‚ùå Jogador com User ID " .. userId .. " n√£o est√° online!")
        return
    end
    
    -- Dar o item
    local addSuccess = PlayerItemsModule.addItem(targetPlayer, itemId, quantity)
    
    if not addSuccess then
        ChatMessage.sendError(player, "‚ùå Erro ao adicionar item!")
        return
    end
    
    local itemConfig = ITEMS_CONFIG[itemId]
    local itemName = itemConfig.name or "Item #" .. itemId
    
    ChatMessage.sendSuccess(player, "‚úÖ " .. quantity .. "x '" .. itemName .. "' dado(s) para " .. targetPlayer.Name .. " [ID: " .. userId .. "]!")
    ChatMessage.sendSuccess(targetPlayer, "üéÅ Voc√™ recebeu " .. quantity .. "x '" .. itemName .. "'!")
end)

